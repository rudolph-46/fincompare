// FinCompare Afrique â€” Database Schema
// Based on PRD v1.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique
  passwordHash  String?
  fullName      String
  avatarUrl     String?
  userType      UserType  @default(CLIENT)
  
  // Client-specific fields
  dateOfBirth   DateTime?
  nationalIdType String?
  nationalIdNumber String?
  employmentStatus String?
  monthlyIncomeRange String?
  city          String?
  region        String?
  
  emailVerified DateTime?
  phoneVerified DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  organisationMembers OrganisationMember[]
  loanApplications    LoanApplication[]
  documents           Document[]
  sentMessages        Message[]            @relation("SentMessages")
  notifications       Notification[]
  invitationsSent     Invitation[]         @relation("InvitationsSent")
  
  // NextAuth
  accounts      Account[]
  sessions      Session[]
}

enum UserType {
  CLIENT
  INSTITUTION_MEMBER
  ADMIN
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

// ============================================
// ORGANISATIONS (Banks, EMFs)
// ============================================

model Organisation {
  id                    String              @id @default(cuid())
  name                  String
  slug                  String              @unique
  type                  OrganisationType
  cobacApprovalNumber   String?             @unique
  cobacApprovalDate     DateTime?
  logoUrl               String?
  description           String?
  website               String?
  phone                 String?
  email                 String?
  headquartersCity      String?
  headquartersAddress   String?
  operatingRegions      String?             // JSON array stored as string
  totalBranches         Int                 @default(0)
  
  verificationStatus    VerificationStatus  @default(PENDING)
  verifiedAt            DateTime?
  verifiedBy            String?
  
  subscriptionPlan      SubscriptionPlan    @default(FREE)
  subscriptionExpiresAt DateTime?
  
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  members               OrganisationMember[]
  branches              Branch[]
  creditProducts        CreditProduct[]
  offers                ApplicationOffer[]
  conversations         Conversation[]
  invitations           Invitation[]
}

enum OrganisationType {
  BANQUE
  EMF_CAT1
  EMF_CAT2
  EMF_CAT3
  ETABLISSEMENT_PAIEMENT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  SUSPENDED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

model OrganisationMember {
  id              String          @id @default(cuid())
  organisationId  String
  userId          String
  role            MemberRole      @default(ANALYST)
  branchId        String?
  invitedBy       String?
  invitedAt       DateTime?
  joinedAt        DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  
  organisation    Organisation    @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch          Branch?         @relation(fields: [branchId], references: [id])
  
  @@unique([organisationId, userId])
}

enum MemberRole {
  ADMIN
  ANALYST
  COMMERCIAL
  READONLY
}

model Branch {
  id              String              @id @default(cuid())
  organisationId  String
  name            String
  city            String
  region          String?
  address         String?
  phone           String?
  latitude        Float?
  longitude       Float?
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  
  organisation    Organisation        @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  members         OrganisationMember[]
  appointments    Appointment[]
}

model Invitation {
  id              String          @id @default(cuid())
  organisationId  String
  email           String
  role            MemberRole
  token           String          @unique
  invitedBy       String
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime
  createdAt       DateTime        @default(now())
  
  organisation    Organisation    @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  inviter         User            @relation("InvitationsSent", fields: [invitedBy], references: [id])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// CREDIT PRODUCTS
// ============================================

model CreditProduct {
  id                    String          @id @default(cuid())
  organisationId        String
  name                  String
  category              CreditCategory
  description           String?
  minAmount             Int
  maxAmount             Int
  minDurationMonths     Int
  maxDurationMonths     Int
  baseInterestRate      Float
  maxInterestRate       Float?
  rateType              RateType        @default(FIXED)
  
  eligibleEmployment    String?         // JSON array
  eligibleRegions       String?         // JSON array
  minIncome             Int?
  maxDebtRatio          Float?          @default(33)
  
  requiresGuarantee     Boolean         @default(false)
  guaranteeType         String?
  requiresDownPayment   Boolean         @default(false)
  minDownPaymentPct     Float?
  
  processingFeePct      Float?
  processingFeeFixed    Int?
  insuranceRequired     Boolean         @default(false)
  documentsRequired     String?         // JSON array
  
  avgProcessingDays     Int?
  isPromoted            Boolean         @default(false)
  isActive              Boolean         @default(true)
  publishedAt           DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  organisation          Organisation    @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  rateGrids             RateGrid[]
  offers                ApplicationOffer[]
}

enum CreditCategory {
  IMMOBILIER
  AUTO
  CONSOMMATION
  PME
  MICRO_CREDIT
  EQUIPEMENT
  SCOLAIRE
  AUTRE
}

enum RateType {
  FIXED
  VARIABLE
  MIXED
}

model RateGrid {
  id                  String        @id @default(cuid())
  creditProductId     String
  employmentStatus    String?
  minDurationMonths   Int?
  maxDurationMonths   Int?
  minAmount           Int?
  maxAmount           Int?
  interestRate        Float
  teg                 Float?
  effectiveFrom       DateTime
  effectiveUntil      DateTime?
  isActive            Boolean       @default(true)
  
  creditProduct       CreditProduct @relation(fields: [creditProductId], references: [id], onDelete: Cascade)
}

// ============================================
// LOAN APPLICATIONS
// ============================================

model LoanApplication {
  id                    String              @id @default(cuid())
  reference             String              @unique
  applicantId           String
  category              CreditCategory
  amountRequested       Int
  durationMonths        Int
  purpose               String?
  
  // Financial info
  monthlyIncome         Int?
  otherIncome           Int?
  existingDebtMonthly   Int                 @default(0)
  hasDownPayment        Boolean             @default(false)
  downPaymentAmount     Int?
  
  // Employment
  employmentStatus      String?
  employerName          String?
  employmentDurationMonths Int?
  
  // Project-specific (JSON)
  projectDetails        String?
  preferredRegions      String?             // JSON array
  
  status                ApplicationStatus   @default(DRAFT)
  submittedAt           DateTime?
  matchedAt             DateTime?
  closedAt              DateTime?
  closeReason           CloseReason?
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  applicant             User                @relation(fields: [applicantId], references: [id])
  documents             Document[]
  offers                ApplicationOffer[]
  conversations         Conversation[]
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  MATCHING
  MATCHED
  CLOSED
  CANCELLED
}

enum CloseReason {
  FUNDED
  REJECTED_ALL
  WITHDRAWN
  EXPIRED
}

model Document {
  id              String        @id @default(cuid())
  applicationId   String?
  ownerId         String
  documentType    DocumentType
  fileUrl         String
  fileName        String?
  fileSize        Int?
  mimeType        String?
  isVerified      Boolean       @default(false)
  uploadedAt      DateTime      @default(now())
  
  application     LoanApplication? @relation(fields: [applicationId], references: [id])
  owner           User          @relation(fields: [ownerId], references: [id])
}

enum DocumentType {
  CNI
  PASSPORT
  BULLETIN_SALAIRE
  ATTESTATION_TRAVAIL
  RELEVE_BANCAIRE
  JUSTIFICATIF_DOMICILE
  TITRE_FONCIER
  DEVIS
  BUSINESS_PLAN
  AUTRE
}

model ApplicationOffer {
  id                      String          @id @default(cuid())
  applicationId           String
  organisationId          String
  creditProductId         String?
  assignedTo              String?
  
  status                  OfferStatus     @default(PENDING)
  
  proposedRate            Float?
  proposedAmount          Int?
  proposedDurationMonths  Int?
  proposedMonthlyPayment  Int?
  processingFee           Int?
  conditions              String?
  rejectionReason         String?
  internalNotes           String?
  
  respondedAt             DateTime?
  acceptedAt              DateTime?
  expiresAt               DateTime?
  
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  
  application             LoanApplication @relation(fields: [applicationId], references: [id])
  organisation            Organisation    @relation(fields: [organisationId], references: [id])
  creditProduct           CreditProduct?  @relation(fields: [creditProductId], references: [id])
  conversation            Conversation?
}

enum OfferStatus {
  PENDING
  REVIEWING
  PRE_APPROVED
  APPROVED
  REJECTED
  COUNTER_OFFER
  ACCEPTED
  EXPIRED
}

// ============================================
// MESSAGING & APPOINTMENTS
// ============================================

model Conversation {
  id              String          @id @default(cuid())
  offerId         String?         @unique
  applicationId   String
  applicantId     String
  organisationId  String
  lastMessageAt   DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  
  offer           ApplicationOffer? @relation(fields: [offerId], references: [id])
  application     LoanApplication @relation(fields: [applicationId], references: [id])
  organisation    Organisation    @relation(fields: [organisationId], references: [id])
  messages        Message[]
  appointments    Appointment[]
}

model Message {
  id              String          @id @default(cuid())
  conversationId  String
  senderId        String
  content         String
  messageType     MessageType     @default(TEXT)
  fileUrl         String?
  isRead          Boolean         @default(false)
  readAt          DateTime?
  createdAt       DateTime        @default(now())
  
  conversation    Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User            @relation("SentMessages", fields: [senderId], references: [id])
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  APPOINTMENT_REQUEST
}

model Appointment {
  id              String            @id @default(cuid())
  conversationId  String
  applicantId     String
  organisationId  String
  assignedTo      String?
  branchId        String?
  
  title           String
  description     String?
  startTime       DateTime
  endTime         DateTime
  location        String?
  meetingType     MeetingType       @default(IN_PERSON)
  
  status          AppointmentStatus @default(PROPOSED)
  proposedBy      String
  confirmedAt     DateTime?
  cancelledReason String?
  reminderSent    Boolean           @default(false)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  conversation    Conversation      @relation(fields: [conversationId], references: [id])
  branch          Branch?           @relation(fields: [branchId], references: [id])
}

enum MeetingType {
  IN_PERSON
  PHONE
  VIDEO
}

enum AppointmentStatus {
  PROPOSED
  CONFIRMED
  RESCHEDULED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String            @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  body        String?
  data        String?           // JSON
  isRead      Boolean           @default(false)
  readAt      DateTime?
  createdAt   DateTime          @default(now())
  
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum NotificationType {
  NEW_OFFER
  OFFER_UPDATE
  NEW_MESSAGE
  APPOINTMENT
  DOCUMENT_REQUEST
  SYSTEM
}

// ============================================
// ANALYTICS
// ============================================

model AnalyticsEvent {
  id              String    @id @default(cuid())
  userId          String?
  organisationId  String?
  eventType       String
  eventData       String?   // JSON
  createdAt       DateTime  @default(now())
}
